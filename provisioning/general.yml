---
- hosts: all
  become: true
  gather_facts: true
  
  tasks:
    - name: Update Apt Cache (Only if older than 1 hour)
      apt:
        update_cache: yes
        cache_valid_time: 3600
      tags: ['setup']

    - name: Install Common Utilities
      apt:
        name:
          - curl
          - wget
          - git
          - htop
        state: present
      tags: ['setup']

    - name: Set Kubernetes repo variables
      vars:
        k8s_version: "v1.32"  
        k8s_repo_url: "https://pkgs.k8s.io/core:/stable:/{{ k8s_version }}/deb/"
        k8s_key_url: "{{ k8s_repo_url }}Release.key"
        k8s_keyring_path: "/etc/apt/keyrings/kubernetes-apt-keyring.gpg"

      block:
        - name: Install APT prerequisites for Kubernetes repo
          apt:
            name:
              - ca-certificates
              - gnupg
              - apt-transport-https
            state: present
          tags: ['setup', 'kubernetes']

        - name: Ensure keyrings directory exists
          file:
            path: /etc/apt/keyrings
            state: directory
            mode: "0755"
          tags: ['setup', 'kubernetes']

        - name: Download Kubernetes APT repository key and dearmor
          ansible.builtin.shell: |
            curl -fsSL {{ k8s_key_url }} | gpg --dearmor -o {{ k8s_keyring_path }}
          args:
            creates: "{{ k8s_keyring_path }}"
          tags: ['setup', 'kubernetes']

        - name: Add Kubernetes apt repository (pkgs.k8s.io)
          apt_repository:
            repo: "deb [signed-by={{ k8s_keyring_path }}] {{ k8s_repo_url }} /"
            filename: "kubernetes"
            state: present
          tags: ['setup', 'kubernetes']

        - name: Update apt cache after adding Kubernetes repo
          apt:
            update_cache: yes
          tags: ['setup', 'kubernetes']

    - name: Add cluster nodes to /etc/hosts
      blockinfile:
        path: /etc/hosts
        marker: "# {mark} ANSIBLE MANAGED BLOCK"
        content: |
          {{ ctrl_ip }} ctrl
          {% for i in range(1, worker_count | int + 1) %}
          {{ subnet_prefix }}.{{ 100 + i }} node-{{ i }}
          {% endfor %}

    - name: Verify Kubernetes repo (concise)
      block:
        - name: Read kubelet policy
          command: apt-cache policy kubelet
          register: kubelet_policy
          changed_when: false
        - name: Print single-line confirmation
          debug:
            msg: >-
              K8s repo OK: kubelet candidate {{
              (kubelet_policy.stdout.splitlines()
              | select('match', '^\s*Candidate:') | list | first
              | regex_replace('^\s*Candidate:\s*','')) | default('unknown') }}
              from pkgs.k8s.io={{ 'pkgs.k8s.io' in kubelet_policy.stdout }}