{
  "schemaVersion": 39,
  "title": "UI Engagement â€“ Experiment Decision Dashboard",
  "version": 3,
  "timezone": "browser",
  "refresh": "10s",
  "time": { "from": "now-30m", "to": "now" },
  "tags": ["experiment", "ui", "decision"],
  "templating": {
    "list": [
      {
        "name": "datasource",
        "type": "datasource",
        "pluginId": "prometheus",
        "label": "Data Source",
        "query": "prometheus"
      },
      {
        "name": "window",
        "type": "interval",
        "label": "Observation window",
        "query": "15m,30m,1h,6h,24h",
        "current": { "text": "30m", "value": "30m" }
      },
      {
        "name": "stableVersion",
        "type": "constant",
        "label": "Stable version",
        "query": "{{ .Values.app.image.tagStable }}"
      },
      {
        "name": "experimentVersion",
        "type": "constant",
        "label": "Experimental version",
        "query": "{{ .Values.app.image.tagExperiment }}"
      }
    ]
  },
  "panels": [
    {
      "id": 1,
      "type": "stat",
      "title": "Total predictions (spam + ham)",
      "description": "Total predictions over the observation window. Stable UI ($stableVersion) vs Experimental UI ($experimentVersion). Higher means more interaction.",
      "gridPos": { "x": 0, "y": 0, "w": 8, "h": 7 },
      "targets": [
        {
          "refId": "S",
          "expr": "round(sum(increase(sms_predictions_total{version=\"$stableVersion\"}[$window])))",
          "legendFormat": "Stable UI ($stableVersion)"
        },
        {
          "refId": "E",
          "expr": "round(sum(increase(sms_predictions_total{version=\"$experimentVersion\"}[$window])))",
          "legendFormat": "Experimental UI ($experimentVersion)"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "decimals": 0
        }
      },
      "options": {
        "orientation": "horizontal",
        "textMode": "value",
        "colorMode": "value",
        "reduceOptions": {
          "calcs": ["lastNotNull"],
          "values": false
        }
      }
    },
    {
      "id": 2,
      "type": "stat",
      "title": "Abandonment rate (abandoned / sessions)",
      "description": "Abandonment rate over the observation window. Stable UI ($stableVersion) vs Experimental UI ($experimentVersion). Lower is better. Sessions proxied by time_on_page count.",
      "gridPos": { "x": 8, "y": 0, "w": 8, "h": 7 },
      "targets": [
        {
          "refId": "S",
          "expr": "sum(increase(sms_pages_abandoned_total{version=\"$stableVersion\"}[$window])) / clamp_min(sum(increase(sms_time_on_page_seconds_count{version=\"$stableVersion\"}[$window])), 1)",
          "legendFormat": "Stable UI ($stableVersion)"
        },
        {
          "refId": "E",
          "expr": "sum(increase(sms_pages_abandoned_total{version=\"$experimentVersion\"}[$window])) / clamp_min(sum(increase(sms_time_on_page_seconds_count{version=\"$experimentVersion\"}[$window])), 1)",
          "legendFormat": "Experimental UI ($experimentVersion)"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "decimals": 3
        }
      },
      "options": {
        "orientation": "horizontal",
        "textMode": "value",
        "colorMode": "value",
        "reduceOptions": {
          "calcs": ["lastNotNull"],
          "values": false
        }
      }
    },
    {
      "id": 3,
      "type": "stat",
      "title": "Time on page (median, p50, seconds)",
      "description": "Median time on page (p50) over the observation window. Stable UI ($stableVersion) vs Experimental UI ($experimentVersion). Higher is better.",
      "gridPos": { "x": 16, "y": 0, "w": 8, "h": 7 },
      "targets": [
        {
          "refId": "S",
          "expr": "histogram_quantile(0.50, sum(rate(sms_time_on_page_seconds_bucket{version=\"$stableVersion\"}[$window])) by (le))",
          "legendFormat": "Stable UI ($stableVersion)"
        },
        {
          "refId": "E",
          "expr": "histogram_quantile(0.50, sum(rate(sms_time_on_page_seconds_bucket{version=\"$experimentVersion\"}[$window])) by (le))",
          "legendFormat": "Experimental UI ($experimentVersion)"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "s",
          "decimals": 1
        }
      },
      "options": {
        "orientation": "horizontal",
        "textMode": "value",
        "colorMode": "value",
        "reduceOptions": {
          "calcs": ["lastNotNull"],
          "values": false
        }
      }
    }
  ]
}
